(()=>{"use strict";var e,t,n,r,s,o,a,l,i;!function(e){e.On="on",e.Off="off",e.Auto="auto"}(e||(e={})),function(e){e.Off="off",e.Fullscreen="fullscreen",e.On="on"}(t||(t={})),function(e){e.Visible="visible",e.Hidden="hidden"}(n||(n={})),function(e){e.Error="error",e.Warn="warn",e.Info="info",e.Debug="debug",e.Trace="trace"}(r||(r={})),function(e){e.Window="window",e.Opaque="opaque",e.Transparent="transparent",e.Direct="direct",e.Gpu="gpu"}(s||(s={})),function(e){e.WebGpu="webgpu",e.WgpuWebgl="wgpu-webgl",e.Webgl="webgl",e.Canvas="canvas"}(o||(o={})),function(e){e.On="on",e.RightClickOnly="rightClickOnly",e.Off="off"}(a||(a={})),function(e){e.Allow="allow",e.Confirm="confirm",e.Deny="deny"}(l||(l={})),function(e){e.All="all",e.Internal="internal",e.None="none"}(i||(i={}));const u={allowScriptAccess:!1,parameters:{},autoplay:e.Auto,backgroundColor:null,letterbox:t.Fullscreen,unmuteOverlay:n.Visible,upgradeToHttps:!0,compatibilityRules:!0,favorFlash:!0,warnOnUnsupportedContent:!0,logLevel:r.Error,showSwfDownload:!1,contextMenu:a.On,preloader:!0,splashScreen:!0,maxExecutionDuration:15,base:null,menu:!0,salign:"",forceAlign:!1,quality:"high",scale:"showAll",forceScale:!1,frameRate:null,wmode:s.Opaque,publicPath:null,polyfills:!0,playerVersion:null,preferredRenderer:null,openUrlMode:l.Allow,allowNetworking:i.All,openInNewTab:null,socketProxy:[],fontSources:[],defaultFonts:{}},c=Object.assign(Object.assign({},u),{ruffleEnable:!0,ignoreOptout:!1,autostart:!1});let d,g,f,p,b,m;function h(e){return new Promise(((t,n)=>{e((e=>{const r=chrome.runtime.lastError;r?n(r):t(e)}))}))}function y(e){return{clear:()=>h((t=>e.clear(t))),get:t=>h((n=>e.get(t||null,n))),remove:t=>h((n=>e.remove(t,n))),set:t=>h((n=>e.set(t,n)))}}if("undefined"!=typeof chrome)d=chrome.i18n,g={local:y(chrome.storage.local),sync:y(chrome.storage.sync),onChanged:{addListener:e=>chrome.storage.onChanged.addListener(e)}},f={reload:e=>h((t=>chrome.tabs.reload(e,void 0,t))),query:e=>h((t=>chrome.tabs.query(e,t))),sendMessage:(e,t,n)=>h((r=>chrome.tabs.sendMessage(e,t,n||{},r)))},p=chrome.runtime,b=()=>h((e=>chrome.tabs.create({url:"/options.html"},e))),m=()=>h((e=>chrome.tabs.create({url:"/player.html"})));else{if("undefined"==typeof browser)throw new Error("Extension API not found.");d=browser.i18n,g=browser.storage,f=browser.tabs,p=browser.runtime,b=()=>browser.runtime.openOptionsPage(),m=()=>h((e=>browser.tabs.create({url:"/player.html"})))}async function w(){const e=await g.sync.get();return Object.assign(Object.assign({},c),e)}class _{constructor(e,t){this.checkbox=e,this.label=t}get input(){return this.checkbox}get value(){return this.checkbox.checked}set value(e){this.checkbox.checked=e}}class v{constructor(e,t){this.numberInput=e,this.label=t,this.numberInput.addEventListener("input",(()=>{this.numberInput.reportValidity()}))}get input(){return this.numberInput}get value(){const e=this.numberInput,t=e.valueAsNumber;if(Number.isNaN(t))return null;if(e.min){const n=Number(e.min);if(n>t)return n}if(e.max){const n=Number(e.max);if(t>n)return n}return t}set value(e){var t;this.numberInput.value=null!==(t=null==e?void 0:e.toString())&&void 0!==t?t:""}}class E{constructor(e,t){this.select=e,this.label=t,Array.prototype.forEach.call(e.options,(e=>{if(e.hasAttribute("id")){const t=d.getMessage(`settings_${e.id}`);t&&(e.textContent=t)}}))}get input(){return this.select}get value(){const e=this.select.selectedIndex;return this.select.options[e].value||null}set value(e){null!=e||(e="");const t=Array.from(this.select.options).findIndex((t=>t.value===e));this.select.selectedIndex=t}}function x(e){const t=e.getElementsByTagName("label")[0],[n]=e.getElementsByTagName("input");if(n){if("checkbox"===n.type)return new _(n,t);if("number"===n.type)return new v(n,t)}const[r]=e.getElementsByTagName("select");if(r)return new E(r,t);throw new Error("Unknown option element")}async function O(e){const t=function(){const e=new Map;for(const t of document.getElementsByClassName("option")){const n=x(t),r=n.input.id.replace(/[^a-z\d](.)/gi,((e,t)=>t.toUpperCase()));e.set(r,n)}return e}(),n=await w();for(const[e,r]of t.entries()){r.value=n[e],r.label.classList.add("notransition"),r.label.offsetHeight,r.label.classList.remove("notransition");const t=d.getMessage(`settings_${r.input.id}`);t&&(r.label.textContent=t),r.input.addEventListener("change",(()=>{const t=r.value;n[e]=t,g.sync.set({[e]:t})}))}g.onChanged.addListener(((r,s)=>{if("sync"===s){for(const[e,s]of Object.entries(r)){const r=t.get(e);r&&(r.value=s.newValue,n[e]=s.newValue)}e&&e(n)}})),e&&e(n)}const C="nightly 2023-11-03";let I,k,A,L,M,N;const B={status_init:"gray",status_message_init:"gray",status_no_tabs:"red",status_result_disabled:"gray",status_result_error:"red",status_result_optout:"gray",status_result_protected:"gray",status_result_running:"green",status_result_running_protected:"green",status_tabs_error:"red"};function j(e,t){if("object"==typeof e&&"object"==typeof t&&null!==e&&null!==t){for(const[n,r]of Object.entries(e))if(!j(r,t[n]))return!1;for(const[n,r]of Object.entries(t))if(!j(r,e[n]))return!1;return!0}return e===t}function q(){if(!A)return;const e=!j(k,A);N.disabled=!e}function T(){!async function(e){let t;e("status_init");try{if(t=await f.query({currentWindow:!0,active:!0}),t.length<1)return void e("status_no_tabs");if(t.length>1)throw new Error(`Got ${t.length} tabs in response to active tab query.`)}catch(t){return void e("status_tabs_error")}I=t[0];const n=I.url?new URL(I.url):null;if(n&&n.origin===window.location.origin&&"/player.html"===n.pathname)return void e("status_result_running_protected");let r;e("status_message_init");try{r=await f.sendMessage(I.id,{type:"ping"})}catch(t){return e("status_result_protected"),void(N.disabled=!0)}r?(A=r.tabOptions,r.loaded?e("status_result_running"):A.ruffleEnable?e("status_result_optout"):e("status_result_disabled"),q()):e("status_result_error")}((e=>{L.style.setProperty("--color",B[e]),M.textContent=d.getMessage(e)}))}window.addEventListener("DOMContentLoaded",(()=>{O((e=>{k=e,q()})),L=document.getElementById("status-indicator"),M=document.getElementById("status-text");document.getElementById("version-text").textContent=`Ruffle extension ${C}`;const e=document.getElementById("options-button");e.textContent=d.getMessage("open_settings_page"),e.addEventListener("click",(async()=>{await b(),window.close()}));const t=document.getElementById("player-button");t.textContent=d.getMessage("open_player_page"),t.addEventListener("click",(async()=>{await m(),window.close()})),N=document.getElementById("reload-button"),N.textContent=d.getMessage("action_reload"),N.addEventListener("click",(async()=>{await f.reload(I.id),window.close()})),T()}))})();